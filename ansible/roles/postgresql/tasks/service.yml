# =============================================================================
# PostgreSQL Service Tasks
# =============================================================================
# Manages the PostgreSQL systemd service.

---
- name: Ensure PostgreSQL service is running
  ansible.builtin.systemd:
    name: "{{ postgresql_service_name }}"
    state: started
    enabled: true

- name: Wait for PostgreSQL to be ready
  ansible.builtin.command:
    cmd: pg_isready -h /var/run/postgresql
  register: pg_ready
  until: pg_ready.rc == 0
  retries: 30
  delay: 2
  changed_when: false

- name: Set postgres admin password
  community.postgresql.postgresql_user:
    name: postgres
    password: "{{ postgresql_admin_password }}"
    state: present
  become: true
  become_user: postgres
  when: postgresql_admin_password is defined and postgresql_admin_password | length > 0
  no_log: true
