# =============================================================================
# PostgreSQL Exporter Tasks
# =============================================================================
# Installs and configures postgres_exporter for Prometheus metrics.

---
- name: Detect system architecture
  ansible.builtin.set_fact:
    exporter_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' if ansible_architecture == 'aarch64' else ansible_architecture }}"

- name: Check if postgres_exporter exists
  ansible.builtin.stat:
    path: /usr/local/bin/postgres_exporter
  register: exporter_binary

- name: Download and install postgres_exporter
  when: not exporter_binary.stat.exists
  block:
    - name: Create temporary directory
      ansible.builtin.tempfile:
        state: directory
        prefix: postgres_exporter_
      register: exporter_temp_dir

    - name: Download postgres_exporter
      ansible.builtin.get_url:
        url: "https://github.com/prometheus-community/postgres_exporter/releases/download/v{{ postgres_exporter_version }}/postgres_exporter-{{ postgres_exporter_version }}.linux-{{ exporter_arch }}.tar.gz"
        dest: "{{ exporter_temp_dir.path }}/postgres_exporter.tar.gz"
        mode: "0644"

    - name: Extract postgres_exporter
      ansible.builtin.unarchive:
        src: "{{ exporter_temp_dir.path }}/postgres_exporter.tar.gz"
        dest: "{{ exporter_temp_dir.path }}"
        remote_src: true

    - name: Install postgres_exporter binary
      ansible.builtin.copy:
        src: "{{ exporter_temp_dir.path }}/postgres_exporter-{{ postgres_exporter_version }}.linux-{{ exporter_arch }}/postgres_exporter"
        dest: /usr/local/bin/postgres_exporter
        mode: "0755"
        owner: root
        group: root
        remote_src: true

    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ exporter_temp_dir.path }}"
        state: absent

- name: Template postgres_exporter systemd service
  ansible.builtin.template:
    src: postgres-exporter.service.j2
    dest: "/etc/systemd/system/{{ postgresql_exporter_service_name }}.service"
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart postgres-exporter

- name: Ensure postgres_exporter service is running
  ansible.builtin.systemd:
    name: "{{ postgresql_exporter_service_name }}"
    state: started
    enabled: true
    daemon_reload: true
