# =============================================================================
# Forgejo Secrets Generation Tasks
# =============================================================================
# Generates required secrets if they don't exist (idempotent).

---
- name: Check if secret_key exists
  ansible.builtin.stat:
    path: "{{ forgejo_data_dir }}/secret_key"
  register: secret_key_file

- name: Generate SECRET_KEY
  ansible.builtin.shell:
    cmd: "{{ forgejo_binary_path }} generate secret SECRET_KEY > {{ forgejo_data_dir }}/secret_key"
  become: true
  become_user: "{{ forgejo_user }}"
  when: not secret_key_file.stat.exists
  args:
    creates: "{{ forgejo_data_dir }}/secret_key"

- name: Set secret_key permissions
  ansible.builtin.file:
    path: "{{ forgejo_data_dir }}/secret_key"
    owner: "{{ forgejo_user }}"
    group: "{{ forgejo_group }}"
    mode: "0600"
  when: not secret_key_file.stat.exists

- name: Check if internal_token exists
  ansible.builtin.stat:
    path: "{{ forgejo_data_dir }}/internal_token"
  register: internal_token_file

- name: Generate INTERNAL_TOKEN
  ansible.builtin.shell:
    cmd: "{{ forgejo_binary_path }} generate secret INTERNAL_TOKEN > {{ forgejo_data_dir }}/internal_token"
  become: true
  become_user: "{{ forgejo_user }}"
  when: not internal_token_file.stat.exists
  args:
    creates: "{{ forgejo_data_dir }}/internal_token"

- name: Set internal_token permissions
  ansible.builtin.file:
    path: "{{ forgejo_data_dir }}/internal_token"
    owner: "{{ forgejo_user }}"
    group: "{{ forgejo_group }}"
    mode: "0600"
  when: not internal_token_file.stat.exists

- name: Check if lfs_jwt_secret exists
  ansible.builtin.stat:
    path: "{{ forgejo_data_dir }}/lfs_jwt_secret"
  register: lfs_jwt_file

- name: Generate LFS_JWT_SECRET
  ansible.builtin.shell:
    cmd: "{{ forgejo_binary_path }} generate secret LFS_JWT_SECRET > {{ forgejo_data_dir }}/lfs_jwt_secret"
  become: true
  become_user: "{{ forgejo_user }}"
  when: not lfs_jwt_file.stat.exists
  args:
    creates: "{{ forgejo_data_dir }}/lfs_jwt_secret"

- name: Set lfs_jwt_secret permissions
  ansible.builtin.file:
    path: "{{ forgejo_data_dir }}/lfs_jwt_secret"
    owner: "{{ forgejo_user }}"
    group: "{{ forgejo_group }}"
    mode: "0600"
  when: not lfs_jwt_file.stat.exists
