name: CI

on:
  push:
    branches-ignore:
      - main
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tftpl'
      - 'docker/**/Dockerfile'
      - 'docker/**/*.sh'
      - 'test/docker/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tftpl'
      - 'docker/**/Dockerfile'
      - 'docker/**/*.sh'
      - 'test/docker/**'
      - '.github/workflows/ci.yml'
      - '.github/workflows/release.yml'

env:
  TOFU_VERSION: '1.9.0'

jobs:
  # =============================================================================
  # Linting
  # =============================================================================
  lint-dockerfiles:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install hadolint
        run: |
          wget -qO hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          chmod +x hadolint

      - name: Run hadolint
        run: |
          THRESHOLD="${{ github.event_name == 'pull_request' && 'warning' || 'error' }}"
          echo "Running hadolint with failure-threshold: $THRESHOLD"
          echo ""
          # Ignore DL3018 (Pin versions in apk add) - we want latest security patches
          find docker -name Dockerfile | while read -r dockerfile; do
            echo "Checking: $dockerfile"
            ./hadolint --failure-threshold "$THRESHOLD" --ignore DL3018 "$dockerfile"
          done

      - name: Summary
        if: always()
        run: |
          echo "## Dockerfile Linting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All Dockerfiles passed linting" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Dockerfile linting issues found - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi

  lint-shell:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          # Check specific directories
          additional_files: 'docker/*/entrypoint.sh docker/*/*.sh test/integration/*.sh terraform/*.sh'
        env:
          # Ignore specific rules:
          # SC1091 - Not following sourced file (common for container scripts)
          # SC3043 - 'local' is undefined in POSIX sh (scripts run in bash/ash)
          # SC2034 - Variable appears unused (often used in sourced context)
          # SC2174 - mkdir -p -m only applies to deepest dir (intentional)
          SHELLCHECK_OPTS: -e SC1091 -e SC3043 -e SC2034 -e SC2174

      - name: Summary
        if: always()
        run: |
          echo "## Shell Script Linting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All shell scripts passed linting" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Shell script linting issues found - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # OpenTofu Validation
  # =============================================================================
  tofu-validate:
    name: Validate OpenTofu
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Check formatting
        id: fmt
        working-directory: terraform
        run: tofu fmt -check -recursive

      - name: Initialize
        id: init
        working-directory: terraform
        run: tofu init -backend=false

      - name: Validate
        id: validate
        working-directory: terraform
        run: tofu validate -no-color

      - name: Summary
        run: |
          echo "## OpenTofu Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Init | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | âœ… Passed |" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Detect Changed Docker Images
  # =============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          # For PRs: compare against base branch; for pushes: compare against previous commit
          base: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.before }}
          filters: |
            alertmanager:
              - 'docker/alertmanager/**'
              - 'test/docker/alertmanager_test.sh'
            atlantis:
              - 'docker/atlantis/**'
              - 'test/docker/atlantis_test.sh'
            caddy:
              - 'docker/caddy/**'
              - 'test/docker/caddy_test.sh'
            cloudflared:
              - 'docker/cloudflared/**'
              - 'test/docker/cloudflared_test.sh'
            grafana:
              - 'docker/grafana/**'
              - 'test/docker/grafana_test.sh'
            loki:
              - 'docker/loki/**'
              - 'test/docker/loki_test.sh'
            prometheus:
              - 'docker/prometheus/**'
              - 'test/docker/prometheus_test.sh'
            step_ca:
              - 'docker/step-ca/**'
              - 'test/docker/step-ca_test.sh'
            node_exporter:
              - 'docker/node-exporter/**'
              - 'test/docker/node-exporter_test.sh'
            ci_workflow:
              - '.github/workflows/ci.yml'
              - '.trivyignore'

      - name: Build matrix
        id: set-matrix
        run: |
          # Check if CI workflow itself changed - if so, build all images
          if [ "${{ steps.filter.outputs.ci_workflow }}" == "true" ]; then
            echo 'matrix=["alertmanager","atlantis","caddy","cloudflared","grafana","loki","node-exporter","prometheus","step-ca"]' >> $GITHUB_OUTPUT
            echo 'has_changes=true' >> $GITHUB_OUTPUT
            echo "ðŸ“‹ CI workflow changed - will build all images"
          else
            # Build only changed images (works for both PRs and feature branches)
            SERVICES=()
            if [ "${{ steps.filter.outputs.alertmanager }}" == "true" ]; then SERVICES+=("alertmanager"); fi
            if [ "${{ steps.filter.outputs.atlantis }}" == "true" ]; then SERVICES+=("atlantis"); fi
            if [ "${{ steps.filter.outputs.caddy }}" == "true" ]; then SERVICES+=("caddy"); fi
            if [ "${{ steps.filter.outputs.cloudflared }}" == "true" ]; then SERVICES+=("cloudflared"); fi
            if [ "${{ steps.filter.outputs.grafana }}" == "true" ]; then SERVICES+=("grafana"); fi
            if [ "${{ steps.filter.outputs.loki }}" == "true" ]; then SERVICES+=("loki"); fi
            if [ "${{ steps.filter.outputs.node_exporter }}" == "true" ]; then SERVICES+=("node-exporter"); fi
            if [ "${{ steps.filter.outputs.prometheus }}" == "true" ]; then SERVICES+=("prometheus"); fi
            if [ "${{ steps.filter.outputs.step_ca }}" == "true" ]; then SERVICES+=("step-ca"); fi

            if [ ${#SERVICES[@]} -eq 0 ]; then
              echo 'matrix=[]' >> $GITHUB_OUTPUT
              echo 'has_changes=false' >> $GITHUB_OUTPUT
              echo "ðŸ“‹ No Docker changes detected"
            else
              JSON_ARRAY=$(printf '%s\n' "${SERVICES[@]}" | jq -R . | jq -s -c .)
              echo "matrix=${JSON_ARRAY}" >> $GITHUB_OUTPUT
              echo 'has_changes=true' >> $GITHUB_OUTPUT
              echo "ðŸ“‹ Changed services: ${SERVICES[*]}"
            fi
          fi

      - name: Summary
        run: |
          echo "## Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.filter.outputs.ci_workflow }}" == "true" ]; then
            echo "âš ï¸ CI workflow changed - building all images" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Service | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| alertmanager | ${{ steps.filter.outputs.alertmanager == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| atlantis | ${{ steps.filter.outputs.atlantis == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| caddy | ${{ steps.filter.outputs.caddy == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| cloudflared | ${{ steps.filter.outputs.cloudflared == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| grafana | ${{ steps.filter.outputs.grafana == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| loki | ${{ steps.filter.outputs.loki == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| node-exporter | ${{ steps.filter.outputs.node_exporter == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| prometheus | ${{ steps.filter.outputs.prometheus == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| step-ca | ${{ steps.filter.outputs.step_ca == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Build Docker Images
  # =============================================================================
  docker-build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [lint-dockerfiles, lint-shell, tofu-validate, detect-changes]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read Step CLI version
        id: step-version
        run: |
          if [ -f .step-version ]; then
            echo "version=$(cat .step-version | tr -d '\n')" >> $GITHUB_OUTPUT
          else
            echo "version=" >> $GITHUB_OUTPUT
          fi

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: ./docker/${{ matrix.service }}
          load: true
          tags: atlas/${{ matrix.service }}:test
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            STEP_VERSION=${{ steps.step-version.outputs.version }}

      - name: Summary
        run: |
          echo "## Docker Build: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Image built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`atlas/${{ matrix.service }}:test\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Context:** \`docker/${{ matrix.service }}\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Test Docker Images
  # =============================================================================
  docker-test:
    name: Test ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [docker-build, detect-changes]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read Step CLI version
        id: step-version
        run: |
          if [ -f .step-version ]; then
            echo "version=$(cat .step-version | tr -d '\n')" >> $GITHUB_OUTPUT
          else
            echo "version=" >> $GITHUB_OUTPUT
          fi

      - name: Build image for testing
        uses: docker/build-push-action@v5
        with:
          context: ./docker/${{ matrix.service }}
          load: true
          tags: atlas/${{ matrix.service }}:test
          cache-from: type=gha,scope=${{ matrix.service }}
          build-args: |
            STEP_VERSION=${{ steps.step-version.outputs.version }}

      - name: Run smoke tests
        env:
          IMAGE: atlas/${{ matrix.service }}:test
        run: |
          chmod +x test/docker/${{ matrix.service }}_test.sh
          test/docker/${{ matrix.service }}_test.sh

      - name: Summary
        if: always()
        run: |
          echo "## Docker Test: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All smoke tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # Security Scan Docker Images
  # =============================================================================
  docker-security:
    name: Scan ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [docker-test, detect-changes]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read Step CLI version
        id: step-version
        run: |
          if [ -f .step-version ]; then
            echo "version=$(cat .step-version | tr -d '\n')" >> $GITHUB_OUTPUT
          else
            echo "version=" >> $GITHUB_OUTPUT
          fi

      - name: Build image for scanning
        uses: docker/build-push-action@v5
        with:
          context: ./docker/${{ matrix.service }}
          load: true
          tags: atlas/${{ matrix.service }}:test
          cache-from: type=gha,scope=${{ matrix.service }}
          build-args: |
            STEP_VERSION=${{ steps.step-version.outputs.version }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: atlas/${{ matrix.service }}:test
          format: table
          exit-code: 1
          severity: CRITICAL
          ignore-unfixed: true
          trivyignores: .trivyignore

      - name: Summary
        if: always()
        run: |
          echo "## Security Scan: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… No CRITICAL vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ CRITICAL vulnerabilities detected - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # CI Summary
  # =============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint-dockerfiles, lint-shell, tofu-validate, detect-changes, docker-build, docker-test, docker-security]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Dockerfiles | ${{ needs.lint-dockerfiles.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Shell Scripts | ${{ needs.lint-shell.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OpenTofu Validate | ${{ needs.tofu-validate.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Detect Changes | ${{ needs.detect-changes.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.detect-changes.outputs.has_changes }}" == "true" ]; then
            echo "| Docker Build | ${{ needs.docker-build.result == 'success' && 'âœ…' || needs.docker-build.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Docker Test | ${{ needs.docker-test.result == 'success' && 'âœ…' || needs.docker-test.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Security Scan | ${{ needs.docker-security.result == 'success' && 'âœ…' || needs.docker-security.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Docker Build | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
            echo "| Docker Test | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
            echo "| Security Scan | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any job failed
        if: |
          needs.lint-dockerfiles.result == 'failure' ||
          needs.lint-shell.result == 'failure' ||
          needs.tofu-validate.result == 'failure' ||
          needs.detect-changes.result == 'failure' ||
          needs.docker-build.result == 'failure' ||
          needs.docker-test.result == 'failure' ||
          needs.docker-security.result == 'failure'
        run: exit 1
