name: CI

on:
  push:
    branches-ignore:
      - main
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tftpl'
      - 'docker/**/Dockerfile'
      - 'docker/**/*.sh'
      - 'test/docker/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tftpl'
      - 'docker/**/Dockerfile'
      - 'docker/**/*.sh'
      - 'test/docker/**'
      - '.github/workflows/ci.yml'
      - '.github/workflows/release.yml'

env:
  TOFU_VERSION: '1.9.0'

jobs:
  # =============================================================================
  # OpenTofu Validation
  # =============================================================================
  tofu-validate:
    name: Validate OpenTofu
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Check formatting
        id: fmt
        working-directory: terraform
        run: tofu fmt -check -recursive

      - name: Initialize
        id: init
        working-directory: terraform
        run: tofu init -backend=false

      - name: Validate
        id: validate
        working-directory: terraform
        run: tofu validate -no-color

      - name: Summary
        run: |
          echo "## OpenTofu Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Init | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | âœ… Passed |" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Detect Changed Docker Images
  # =============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event.before }}
          filters: |
            alertmanager:
              - 'docker/alertmanager/**'
              - 'test/docker/alertmanager_test.sh'
            caddy:
              - 'docker/caddy/**'
              - 'test/docker/caddy_test.sh'
            cloudflared:
              - 'docker/cloudflared/**'
              - 'test/docker/cloudflared_test.sh'
            grafana:
              - 'docker/grafana/**'
              - 'test/docker/grafana_test.sh'
            loki:
              - 'docker/loki/**'
              - 'test/docker/loki_test.sh'
            mosquitto:
              - 'docker/mosquitto/**'
              - 'test/docker/mosquitto_test.sh'
            prometheus:
              - 'docker/prometheus/**'
              - 'test/docker/prometheus_test.sh'
            step_ca:
              - 'docker/step-ca/**'
              - 'test/docker/step-ca_test.sh'
            node_exporter:
              - 'docker/node-exporter/**'
              - 'test/docker/node-exporter_test.sh'

      - name: Build matrix
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PRs: Build all images for full validation
            echo 'matrix=["alertmanager","caddy","cloudflared","grafana","loki","mosquitto","node-exporter","prometheus","step-ca"]' >> $GITHUB_OUTPUT
            echo 'has_changes=true' >> $GITHUB_OUTPUT
            echo "ðŸ“‹ PR detected - will build all images"
          else
            # Feature branches: Only build changed images
            SERVICES=()
            if [ "${{ steps.filter.outputs.alertmanager }}" == "true" ]; then SERVICES+=("alertmanager"); fi
            if [ "${{ steps.filter.outputs.caddy }}" == "true" ]; then SERVICES+=("caddy"); fi
            if [ "${{ steps.filter.outputs.cloudflared }}" == "true" ]; then SERVICES+=("cloudflared"); fi
            if [ "${{ steps.filter.outputs.grafana }}" == "true" ]; then SERVICES+=("grafana"); fi
            if [ "${{ steps.filter.outputs.loki }}" == "true" ]; then SERVICES+=("loki"); fi
            if [ "${{ steps.filter.outputs.mosquitto }}" == "true" ]; then SERVICES+=("mosquitto"); fi
            if [ "${{ steps.filter.outputs.prometheus }}" == "true" ]; then SERVICES+=("prometheus"); fi
            if [ "${{ steps.filter.outputs.step_ca }}" == "true" ]; then SERVICES+=("step-ca"); fi
            if [ "${{ steps.filter.outputs.node_exporter }}" == "true" ]; then SERVICES+=("node-exporter"); fi

            if [ ${#SERVICES[@]} -eq 0 ]; then
              echo 'matrix=[]' >> $GITHUB_OUTPUT
              echo 'has_changes=false' >> $GITHUB_OUTPUT
              echo "ðŸ“‹ No Docker changes detected"
            else
              JSON_ARRAY=$(printf '%s\n' "${SERVICES[@]}" | jq -R . | jq -s -c .)
              echo "matrix=${JSON_ARRAY}" >> $GITHUB_OUTPUT
              echo 'has_changes=true' >> $GITHUB_OUTPUT
              echo "ðŸ“‹ Changed services: ${SERVICES[*]}"
            fi
          fi

      - name: Summary
        run: |
          echo "## Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "**Mode:** Pull Request (full build)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All images will be built for complete validation." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Feature Branch (selective build)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Service | Changed |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
            echo "| alertmanager | ${{ steps.filter.outputs.alertmanager == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| caddy | ${{ steps.filter.outputs.caddy == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| cloudflared | ${{ steps.filter.outputs.cloudflared == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| grafana | ${{ steps.filter.outputs.grafana == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| loki | ${{ steps.filter.outputs.loki == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| mosquitto | ${{ steps.filter.outputs.mosquitto == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| prometheus | ${{ steps.filter.outputs.prometheus == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| step-ca | ${{ steps.filter.outputs.step_ca == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| node-exporter | ${{ steps.filter.outputs.node_exporter == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # Build Docker Images
  # =============================================================================
  docker-build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [tofu-validate, detect-changes]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: ./docker/${{ matrix.service }}
          load: true
          tags: atlas/${{ matrix.service }}:test
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

      - name: Summary
        run: |
          echo "## Docker Build: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Image built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`atlas/${{ matrix.service }}:test\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Context:** \`docker/${{ matrix.service }}\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Test Docker Images
  # =============================================================================
  docker-test:
    name: Test ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [docker-build, detect-changes]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for testing
        uses: docker/build-push-action@v5
        with:
          context: ./docker/${{ matrix.service }}
          load: true
          tags: atlas/${{ matrix.service }}:test
          cache-from: type=gha,scope=${{ matrix.service }}

      - name: Run smoke tests
        env:
          IMAGE: atlas/${{ matrix.service }}:test
        run: |
          chmod +x test/docker/${{ matrix.service }}_test.sh
          test/docker/${{ matrix.service }}_test.sh

      - name: Summary
        if: always()
        run: |
          echo "## Docker Test: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All smoke tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # Security Scan Docker Images
  # =============================================================================
  docker-security:
    name: Scan ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [docker-test, detect-changes]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        uses: docker/build-push-action@v5
        with:
          context: ./docker/${{ matrix.service }}
          load: true
          tags: atlas/${{ matrix.service }}:test
          cache-from: type=gha,scope=${{ matrix.service }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: atlas/${{ matrix.service }}:test
          format: table
          exit-code: 1
          severity: CRITICAL
          ignore-unfixed: true

      - name: Summary
        if: always()
        run: |
          echo "## Security Scan: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… No CRITICAL vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ CRITICAL vulnerabilities detected - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # CI Summary
  # =============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [tofu-validate, detect-changes, docker-build, docker-test, docker-security]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| OpenTofu Validate | ${{ needs.tofu-validate.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Detect Changes | ${{ needs.detect-changes.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.detect-changes.outputs.has_changes }}" == "true" ]; then
            echo "| Docker Build | ${{ needs.docker-build.result == 'success' && 'âœ…' || needs.docker-build.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Docker Test | ${{ needs.docker-test.result == 'success' && 'âœ…' || needs.docker-test.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Security Scan | ${{ needs.docker-security.result == 'success' && 'âœ…' || needs.docker-security.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Docker Build | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
            echo "| Docker Test | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
            echo "| Security Scan | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any job failed
        if: |
          needs.tofu-validate.result == 'failure' ||
          needs.detect-changes.result == 'failure' ||
          needs.docker-build.result == 'failure' ||
          needs.docker-test.result == 'failure' ||
          needs.docker-security.result == 'failure'
        run: exit 1
