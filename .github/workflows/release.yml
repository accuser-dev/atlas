name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tftpl'
      - 'docker/**/Dockerfile'
      - '.github/workflows/release.yml'

env:
  TOFU_VERSION: '1.9.0'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository }}

jobs:
  # =============================================================================
  # Quick Validation
  # =============================================================================
  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Validate OpenTofu
        working-directory: terraform
        run: |
          tofu init -backend=false
          tofu validate -no-color

      - name: Summary
        run: |
          echo "## Pre-Release Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… OpenTofu configuration is valid" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Build and Push Docker Images
  # =============================================================================
  docker-release:
    name: Release ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [alertmanager, atlantis, caddy, cloudflared, grafana, loki, mosquitto, node-exporter, prometheus, step-ca]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./docker/${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

      - name: Summary
        run: |
          echo "## Release: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Image published to GitHub Container Registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Release Summary
  # =============================================================================
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: docker-release
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| alertmanager | \`${{ env.IMAGE_PREFIX }}/alertmanager:latest\` | ${{ needs.docker-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| atlantis | \`${{ env.IMAGE_PREFIX }}/atlantis:latest\` | ${{ needs.docker-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| caddy | \`${{ env.IMAGE_PREFIX }}/caddy:latest\` | ${{ needs.docker-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| cloudflared | \`${{ env.IMAGE_PREFIX }}/cloudflared:latest\` | ${{ needs.docker-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| grafana | \`${{ env.IMAGE_PREFIX }}/grafana:latest\` | ${{ needs.docker-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| loki | \`${{ env.IMAGE_PREFIX }}/loki:latest\` | ${{ needs.docker-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| mosquitto | \`${{ env.IMAGE_PREFIX }}/mosquitto:latest\` | ${{ needs.docker-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| node-exporter | \`${{ env.IMAGE_PREFIX }}/node-exporter:latest\` | ${{ needs.docker-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| prometheus | \`${{ env.IMAGE_PREFIX }}/prometheus:latest\` | ${{ needs.docker-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| step-ca | \`${{ env.IMAGE_PREFIX }}/step-ca:latest\` | ${{ needs.docker-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.docker-release.result }}" == "success" ]; then
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To deploy the updated images:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "cd terraform && tofu apply" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if release failed
        if: needs.docker-release.result == 'failure'
        run: exit 1

# NOTE: GitHub packages are private by default. To allow Incus to pull images
# without authentication, you must manually set each package to public:
#   1. Go to https://github.com/orgs/accuser/packages or your user packages page
#   2. Click on each package (alertmanager, atlantis, caddy, cloudflared, grafana, loki, mosquitto, node-exporter, prometheus, step-ca)
#   3. Go to Package settings
#   4. Under "Danger Zone", change visibility to "Public"
#
# This only needs to be done once per package after first publish.
