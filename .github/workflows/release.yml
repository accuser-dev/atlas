name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**/*.tf'
      - 'terraform/**/*.tftpl'
      - 'docker/**/Dockerfile'
      - 'docker/**/*.sh'
      - '.github/workflows/release.yml'
      - '.step-version'

env:
  TOFU_VERSION: '1.9.0'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository }}
  # Step CLI version is read from .step-version file in each job that needs it

jobs:
  # =============================================================================
  # Quick Validation
  # =============================================================================
  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Validate OpenTofu
        working-directory: terraform
        run: |
          tofu init -backend=false
          tofu validate -no-color

      - name: Summary
        run: |
          echo "## Pre-Release Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… OpenTofu configuration is valid" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Detect Changed Docker Images
  # =============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_docker_changes: ${{ steps.set-matrix.outputs.has_docker_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event.before }}
          filters: |
            alertmanager:
              - 'docker/alertmanager/**'
              - '.step-version'
            atlantis:
              - 'docker/atlantis/**'
            caddy:
              - 'docker/caddy/**'
            cloudflared:
              - 'docker/cloudflared/**'
            grafana:
              - 'docker/grafana/**'
              - '.step-version'
            loki:
              - 'docker/loki/**'
              - '.step-version'
            prometheus:
              - 'docker/prometheus/**'
              - '.step-version'
            step_ca:
              - 'docker/step-ca/**'
            release_workflow:
              - '.github/workflows/release.yml'

      - name: Build matrix
        id: set-matrix
        run: |
          # Check if release workflow itself changed - if so, build all images
          if [ "${{ steps.filter.outputs.release_workflow }}" == "true" ]; then
            echo 'matrix=["alertmanager","atlantis","caddy","cloudflared","grafana","loki","prometheus","step-ca"]' >> $GITHUB_OUTPUT
            echo 'has_docker_changes=true' >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Release workflow changed - will build all images"
          else
            # Build only changed images
            SERVICES=()
            if [ "${{ steps.filter.outputs.alertmanager }}" == "true" ]; then SERVICES+=("alertmanager"); fi
            if [ "${{ steps.filter.outputs.atlantis }}" == "true" ]; then SERVICES+=("atlantis"); fi
            if [ "${{ steps.filter.outputs.caddy }}" == "true" ]; then SERVICES+=("caddy"); fi
            if [ "${{ steps.filter.outputs.cloudflared }}" == "true" ]; then SERVICES+=("cloudflared"); fi
            if [ "${{ steps.filter.outputs.grafana }}" == "true" ]; then SERVICES+=("grafana"); fi
            if [ "${{ steps.filter.outputs.loki }}" == "true" ]; then SERVICES+=("loki"); fi
            if [ "${{ steps.filter.outputs.prometheus }}" == "true" ]; then SERVICES+=("prometheus"); fi
            if [ "${{ steps.filter.outputs.step_ca }}" == "true" ]; then SERVICES+=("step-ca"); fi

            if [ ${#SERVICES[@]} -eq 0 ]; then
              echo 'matrix=[]' >> $GITHUB_OUTPUT
              echo 'has_docker_changes=false' >> $GITHUB_OUTPUT
              echo "ðŸ“‹ No Docker changes detected (terraform-only change)"
            else
              JSON_ARRAY=$(printf '%s\n' "${SERVICES[@]}" | jq -R . | jq -s -c .)
              echo "matrix=${JSON_ARRAY}" >> $GITHUB_OUTPUT
              echo 'has_docker_changes=true' >> $GITHUB_OUTPUT
              echo "ðŸ“‹ Changed services: ${SERVICES[*]}"
            fi
          fi

      - name: Summary
        run: |
          echo "## Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.filter.outputs.release_workflow }}" == "true" ]; then
            echo "âš ï¸ Release workflow changed - building all images" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Service | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| alertmanager | ${{ steps.filter.outputs.alertmanager == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| atlantis | ${{ steps.filter.outputs.atlantis == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| caddy | ${{ steps.filter.outputs.caddy == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| cloudflared | ${{ steps.filter.outputs.cloudflared == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| grafana | ${{ steps.filter.outputs.grafana == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| loki | ${{ steps.filter.outputs.loki == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| prometheus | ${{ steps.filter.outputs.prometheus == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| step-ca | ${{ steps.filter.outputs.step_ca == 'true' && 'âœ…' || 'â€”' }} |" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Build and Push Docker Images
  # =============================================================================
  docker-release:
    name: Release ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [validate, detect-changes]
    if: needs.detect-changes.outputs.has_docker_changes == 'true'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Read Step CLI version
        id: step-version
        run: |
          if [ -f .step-version ]; then
            echo "version=$(cat .step-version | tr -d '\n')" >> $GITHUB_OUTPUT
          else
            echo "version=" >> $GITHUB_OUTPUT
          fi

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./docker/${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            STEP_VERSION=${{ steps.step-version.outputs.version }}

      - name: Summary
        run: |
          echo "## Release: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Image published to GitHub Container Registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Release Summary
  # =============================================================================
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, docker-release]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.has_docker_changes }}" == "true" ]; then
            echo "### Published Images" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
            # Parse the matrix to show which images were built
            MATRIX='${{ needs.detect-changes.outputs.matrix }}'
            for service in $(echo "$MATRIX" | jq -r '.[]'); do
              echo "| $service | ${{ needs.docker-release.result == 'success' && 'âœ… Published' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.docker-release.result }}" == "success" ]; then
              echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "To deploy the updated images:" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo "cd terraform && tofu apply" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### No Docker Images Published" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This release only contained Terraform changes. No Docker images were rebuilt." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Existing images remain at their current versions." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if release failed
        if: needs.docker-release.result == 'failure'
        run: exit 1

# NOTE: GitHub packages are private by default. To allow Incus to pull images
# without authentication, you must manually set each package to public:
#   1. Go to https://github.com/orgs/accuser/packages or your user packages page
#   2. Click on each package (alertmanager, atlantis, caddy, cloudflared, grafana, loki, prometheus, step-ca)
#   3. Go to Package settings
#   4. Under "Danger Zone", change visibility to "Public"
#
# This only needs to be done once per package after first publish.
